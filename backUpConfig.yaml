trigger: none  # No se ejecuta automáticamente por commits

schedules:  # Programa la ejecución el primer día de cada mes
  - cron: "0 0 1 * *"  # A medianoche del primer día de cada mes
    displayName: Monthly Backup
    branches:
      include:
        - "*"

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Backup_All_Repos
    displayName: "Monthly Backup of All Repositories"
    jobs:
      - job: BackupRepos
        displayName: "Backup All Repositories"
        steps:
          # Paso 1: Configurar la fecha en una variable
          - script: |
              BACKUP_DATE=$(date +%Y-%m-%d)
              echo "##vso[task.setvariable variable=BACKUP_DATE]$BACKUP_DATE"
              echo "Backup date set to: $BACKUP_DATE"
            displayName: "Set Backup Date"

          # Paso 2: Clonar los repositorios y crear backups
          - script: |
              repo_urls=(
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/BackOffice40Middleware"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/BO40-AppMovil"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/BO40-CW-Printer-Redeban"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/BO40-SaleRecovery"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/COL-Independientes-BO40-Consumer"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/COL-Texaco-BO40-Consumer"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/COL-Texaco-BO40-WebApi"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/COL-Vanti-BO40-Consumer"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/COL-Vanti-BO40-WebAPI"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/MEX-CDC-Front"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/MEX-CDC-WebAPI"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/MEX-Independientes-BO40-Consumer"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-40-TI-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-40-TI-HARDWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-50"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-BOOTLOADER-TI-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-GAS-TI-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-LEGACY-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-LEGACY-HARDWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-LIQUID-TI-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-MEXICO-NATGAS-OASIS-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/TI-MRU-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/WIRELESS-READER-FIRMWARE"
                "https://$(GIT_PAT)@dev.azure.com/consware-gasdata/Gestión%20Gasdata/_git/WIRELESS-READER-HARDWARE"
              )

              BACKUP_FOLDER="backups_$(BACKUP_DATE)"
              mkdir -p $BACKUP_FOLDER

              for repo in "${repo_urls[@]}"; do
                repo_name=$(basename $repo)
                echo "Cloning $repo_name..."
                git clone --depth 1 $repo $repo_name
                zip -r "$BACKUP_FOLDER/${repo_name}_backup.zip" $repo_name
                rm -rf $repo_name
              done

              echo "Backups created in folder: $BACKUP_FOLDER"
            displayName: "Clone Repos and Create Backups"

          # Paso 3: Publicar la carpeta de backups como artefacto
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'backups_$(BACKUP_DATE)'
              ArtifactName: 'Monthly_Backups_$(Build.BuildId)'
              publishLocation: 'Container'
            displayName: "Publish Backup Folder as Artifact"